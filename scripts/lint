#!/usr/bin/env bash

set -euo pipefail

# Lint script for Claude PHP SDK
# Equivalent to Python SDK's lint script using Ruff + Pyright + Mypy

echo "ğŸ” Linting Claude PHP SDK code..."

ERRORS=0

# Define directories to lint
DIRS_TO_LINT=(
    "src"
    "tests"
)

echo "ğŸ§¹ Running PHP CodeSniffer (PSR-12 compliance)..."
for DIR in "${DIRS_TO_LINT[@]}"; do
    if [[ -d "$DIR" ]]; then
        echo "  ğŸ“ Checking $DIR..."
        if ! ./vendor/bin/phpcs --standard=PSR12 "$DIR" --ignore=vendor; then
            ERRORS=$((ERRORS + 1))
            echo "âŒ PHP CodeSniffer found issues in $DIR"
        else
            echo "âœ… $DIR passes PSR-12 compliance"
        fi
    fi
done

echo ""
echo "ğŸ”¬ Running PHPStan (Static Analysis)..."
for DIR in "${DIRS_TO_LINT[@]}"; do
    if [[ -d "$DIR" ]]; then
        echo "  ğŸ“ Analyzing $DIR..."
        if ! ./vendor/bin/phpstan analyse "$DIR" --level=9 --no-progress; then
            ERRORS=$((ERRORS + 1))
            echo "âŒ PHPStan found issues in $DIR"
        else
            echo "âœ… $DIR passes static analysis"
        fi
    fi
done

echo ""
echo "ğŸ”§ Running PHP-CS-Fixer (dry-run)..."
for DIR in "${DIRS_TO_LINT[@]}"; do
    if [[ -d "$DIR" ]]; then
        echo "  ğŸ“ Checking $DIR..."
        if ! ./vendor/bin/php-cs-fixer fix "$DIR" --config=.php-cs-fixer.php --dry-run --diff; then
            ERRORS=$((ERRORS + 1))
            echo "âŒ PHP-CS-Fixer found formatting issues in $DIR"
            echo "ğŸ’¡ Run './scripts/format' to fix formatting issues"
        else
            echo "âœ… $DIR has proper formatting"
        fi
    fi
done

echo ""
echo "ğŸ“¦ Verifying autoload integrity..."
if ! composer dump-autoload --optimize --strict-psr; then
    ERRORS=$((ERRORS + 1))
    echo "âŒ Autoload verification failed"
else
    echo "âœ… Autoload integrity verified"
fi

echo ""
echo "ğŸ” Checking for common PHP issues..."

# Check for PHP syntax errors
for DIR in "${DIRS_TO_LINT[@]}"; do
    if [[ -d "$DIR" ]]; then
        echo "  ğŸ“ Syntax check for $DIR..."
        if ! find "$DIR" -name "*.php" -exec php -l {} \; | grep -v "No syntax errors detected"; then
            ERRORS=$((ERRORS + 1))
            echo "âŒ Syntax errors found in $DIR"
        else
            echo "âœ… No syntax errors in $DIR"
        fi
    fi
done

# Check for TODO/FIXME comments (informational)
echo ""
echo "ğŸ“ Checking for TODO/FIXME comments..."
TODO_COUNT=$(find "${DIRS_TO_LINT[@]}" -name "*.php" -exec grep -l "TODO\|FIXME" {} \; 2>/dev/null | wc -l || echo "0")
if [[ $TODO_COUNT -gt 0 ]]; then
    echo "â„¹ï¸  Found $TODO_COUNT files with TODO/FIXME comments"
    find "${DIRS_TO_LINT[@]}" -name "*.php" -exec grep -Hn "TODO\|FIXME" {} \; 2>/dev/null || true
fi

echo ""
if [[ $ERRORS -eq 0 ]]; then
    echo "ğŸ‰ All linting checks passed!"
    exit 0
else
    echo "âŒ Linting failed with $ERRORS error(s)"
    echo ""
    echo "ğŸ’¡ Quick fixes:"
    echo "  - Run './scripts/format' to fix formatting issues"
    echo "  - Check PHPStan errors and fix type issues"
    echo "  - Ensure PSR-12 compliance"
    exit 1
fi