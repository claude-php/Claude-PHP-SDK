#!/usr/bin/env bash

set -euo pipefail

# Format script for Claude PHP SDK
# Equivalent to Python SDK's format script using Ruff

echo "üé® Formatting Claude PHP SDK code..."

# Check if php-cs-fixer is available
if [[ ! -f "./vendor/bin/php-cs-fixer" ]]; then
    echo "‚ùå PHP-CS-Fixer not found. Run './scripts/bootstrap' first."
    exit 1
fi

# Define directories to format
DIRS_TO_FORMAT=(
    "src"
    "tests"
)

# Check if directories exist and format them
for DIR in "${DIRS_TO_FORMAT[@]}"; do
    if [[ -d "$DIR" ]]; then
        echo "üìÅ Formatting $DIR..."
        ./vendor/bin/php-cs-fixer fix "$DIR" \
            --config=.php-cs-fixer.php \
            --verbose \
            --diff \
            || echo "‚ö†Ô∏è  Warning: Some files in $DIR could not be formatted"
    else
        echo "‚ö†Ô∏è  Directory $DIR not found, skipping..."
    fi
done

# Format any standalone PHP files in the root
if ls ./*.php 1> /dev/null 2>&1; then
    echo "üìÅ Formatting root PHP files..."
    ./vendor/bin/php-cs-fixer fix ./*.php \
        --config=.php-cs-fixer.php \
        --verbose \
        --diff \
        || echo "‚ö†Ô∏è  Warning: Some root PHP files could not be formatted"
fi

# Also run basic PSR-12 formatting as a backup
echo "üîß Running PSR-12 compliance check..."
for DIR in "${DIRS_TO_FORMAT[@]}"; do
    if [[ -d "$DIR" ]]; then
        ./vendor/bin/phpcbf --standard=PSR12 "$DIR" --ignore=vendor || true
    fi
done

echo "‚úÖ Code formatting completed!"
echo ""
echo "üí° Tip: Configure your IDE to run php-cs-fixer on save for automatic formatting."